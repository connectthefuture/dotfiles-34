#!/bin/sh
# dotfiles manager

profile=${1}
results=()
meta=false

# make sure the DOTFILES_PATH global exists
if [ -z ${DOTFILES_PATH} ]
then
    export DOTFILES_PATH=${HOME}/.dotfiles
fi

# only run if a profile was passed in and the profile exists
if [ ! -z ${profile} ] && [ -d ${DOTFILES_PATH}/profiles/${profile} ]
then
    # if the DOTFILES_CURRENT_PROFILE_PATH global exists, store it as previous_profile_path
    if [ ! -z ${DOTFILES_CURRENT_PROFILE_PATH} ]
    then
        previous_profile_path=${DOTFILES_CURRENT_PROFILE_PATH}
    fi

    # update the DOTFILES_CURRENT_PROFILE_PATH global
    export DOTFILES_CURRENT_PROFILE_PATH=${DOTFILES_PATH}/profiles/${profile}

    # show hidden files
    shopt -s dotglob

    # loop through all files in the profile directory
    for file in ${DOTFILES_CURRENT_PROFILE_PATH}/*
    do
        base=`basename ${file}`

        # if there is a meta .dotfiles directory (or file), set the meta flag to true and skip over it
        if [[ ${base} == '.dotfiles' ]]
        then
            meta=true
        # make sure a file was actually found in the directory
        elif [[ ${file} != ${DOTFILES_CURRENT_PROFILE_PATH}'/*' ]]
        then
            # if the file already exists in the user's home directory, we need to remove it
            if [ -f ${HOME}/${base} ] || [ -d ${HOME}/${base} ]
            then
                rm -r ${HOME}/${base}
            fi

            # set up the symlinks
            ln -s ${file} ${HOME}/${base}

            # append the results to an array for reporting
            results+=(${base})
        fi
    done

    # run necessary actions on each new dotfile
    for filename in "${results[@]}"
    do
        # report the new symlinks to the user
        echo "${HOME}/${filename} -> ${DOTFILES_CURRENT_PROFILE_PATH}/${filename}"

        # check for meta script and run if it exists
        if [ -f ${DOTFILES_CURRENT_PROFILE_PATH}/.dotfiles/scripts/${filename}.sh ]
        then
            echo "Running script for ${filename}..."
            source ${DOTFILES_CURRENT_PROFILE_PATH}/.dotfiles/scripts/${filename}.sh
        fi
    done
# list the available profiles
else
    echo 'Available profiles:'

    for dir in ${DOTFILES_PATH}/profiles/*
    do
        if [[ ${dir} != ${DOTFILES_PATH}/profiles'/*' ]]
        then
            base=`basename ${dir}`

            echo " -> ${base}"
        fi
    done
fi
